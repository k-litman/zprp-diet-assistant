Settings
========

This project is configured via environment variables. This document enumerates and describes available configuration 
variables.

### Configuration modules and environments
Application configuration modules shouldn't be coupled to specific environments, but rather to broad use cases. As such,
we don't maintain separate modules for development, staging, or production environments. Instead, we have:

* [base.py]: Common settings between environments
* [local.py]: Settings for the local development environment
* [test.py]: Settings for running tests
* [production.py]: All other environments, including dev, staging, production, etc.

Different "production" environments should be differentiated by setting environment variables rather than separate
configuration modules.


### Handling default values

As a rule, we try to maintain as little divergence as possible between the settings modules. Unfortunately, some
values, which should apply to every environment (and therefore be defined in [base.py]), should also have defaults
in the local environment, but not in production. We handle this by setting the default in the [env template file](../.env.template)
instead of a configuration module.

[production.py]: ../diet_assistant/config/settings/production.py
[local.py]: ../diet_assistant/config/settings/local.py
[test.py]: ../diet_assistant/config/settings/test.py
[base.py]: ../diet_assistant/config/settings/base.py

### Django's built-in settings
For the sake of namespacing, we attach the `DJANGO_` prefix to some of Django's
existing settings. See [the official documentation](https://docs.djangoproject.com/en/3.2/ref/settings/) for reference.
The following table maps environment variables to their Django setting:


| Environment Variable                   | Django Setting                 |  Development Default  | Production Default |
|----------------------------------------|--------------------------------|-----------------------|--------------------|
| DJANGO_ADMIN_URL                       | n/a                            | `admin`               | `admin`            |
| DJANGO_DEBUG                           | DEBUG                          | True                  | False              |
| DJANGO_SECRET_KEY                      | SECRET_KEY                     | autogenerated         | raises error       |
| DJANGO_ALLOWED_HOSTS                   | ALLOWED_HOSTS                  | n/a                   | raises error       |
| DJANGO_SECURE_SSL_REDIRECT             | SECURE_SSL_REDIRECT            | n/a                   | True               |
| DJANGO_SECURE_CONTENT_TYPE_NOSNIFF     | SECURE_CONTENT_TYPE_NOSNIFF    | n/a                   | True               |
| DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS  | SECURE_HSTS_INCLUDE_SUBDOMAINS | n/a                   | True               |
| DJANGO_SECURE_HSTS_PRELOAD             | SECURE_HSTS_PRELOAD            | n/a                   | True               |

### Database settings
Connection to PostgreSQL can be configured via the following set of self-explanatory settings:

* `POSTGRES_HOST`
* `POSTGRES_DB`
* `POSTGRES_PORT`
* `POSTGRES_USER`
* `POSTGRES_PASSWORD`
* `CONN_MAX_AGE`

Alternatively, a full db connection string can be set via the `DATABASE_URL` variable.

### Cache settings
Cache uses Redis by default and is configured by passing in a `REDIS_URL`. This is normally expected to contain a
database number, but Heroku presents a special case, where this is not passed in. In that case a `CACHE_REDIS_DB`
can be set to specify a database number other than 0, which is the default.

| Environment Variable |  Development Default          | Production Default            |
|----------------------|-------------------------------|-------------------------------|
| REDIS_URL            | redis://redis:6379/0          | raises error                  | 
| CACHE_REDIS_DB       | 0 if not present in REDIS_URL | 0 if not present in REDIS_URL |

### AWS settings
AWS client libraries can be configured directly via their own environment variables, bypassing the application. This
is especially true for authentication, where mechanisms external to the application (like EC2 instance profiles or 
IAM roles for service accounts in Kubernetes) are the preferred configuration method.

For this reason, most of the configuration in this section involves third-party libraries like [django-storages](https://django-storages.readthedocs.io/en/latest/).

| Environment Variable                   | Django Setting              |  Development Default  | Production Default    |
|----------------------------------------|-----------------------------|-----------------------|-----------------------|
| DJANGO_AWS_STORAGE_BUCKET_NAME         | AWS_STORAGE_BUCKET_NAME     | n/a                   | raises error          |
| DJANGO_S3_REGION_NAME                  | AWS_S3_REGION_NAME          | n/a                   | raises error          |
| DJANGO_AWS_MEDIA_QUERYSTRING_AUTH      | AWS_MEDIA_QUERYSTRING_AUTH  | n/a                   | True                  |
| DJANGO_AWS_DEFAULT_ACL_MEDIA           | AWS_DEFAULT_ACL_MEDIA       | n/a                   | private               |
| DJANGO_AWS_S3_MEMORY_SIZE              | AWS_S3_MAX_MEMORY_SIZE      | n/a                   | 4 MB                  |

### Sentry settings
The Sentry client is directly configured via its own environment variables, and much like the AWS credentials, these
are not handled by the application itself. These options are: `SENTRY_DSN`, `SENTRY_ENVIRONMENT` and `SENTRY_RELEASE`.
See [the official documentation](https://docs.sentry.io/platforms/python/configuration/options/#common-options) for 
reference.

The application does set values for `SENTRY_ENVIRONMENT` and `SENTRY_RELEASE` by default.

| Environment Variable| Production Default           |
|---------------------|------------------------------|
| SENTRY_ENVIRONMENT  | production                   | 
| SENTRY_RELEASE      | {project_name}@{app_version} |


### Other third party library settings
| Environment Variable                   |   Development Default  | Production Default |
|----------------------------------------|------------------------|--------------------|
| CELERY_BROKER_URL                      | redis://redis:6379     | raises error       |
| CORS_ORIGIN_WHITELIST                  | n/a                    | raises error       |

--------------------------
Application-specific settings
--------------------------
Add your application-specific settings here.
